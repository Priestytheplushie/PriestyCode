name: PriestyBot PR Review

on:
  pull_request:
    types: [ review_requested ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  code-review:
    if: github.event.action == 'review_requested' && github.event.requested_reviewer.login == 'PriestyBot'
    runs-on: ubuntu-latest
    steps:
      - name: ü§ñ PriestyBot, Reporting for Duty!
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.APPROVER_TOKEN }}
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "PriestyBot, reporting for duty! ü´° I'll start my review now and post a final summary once I'm done. Wish me luck! üöÄ"
            });

      - name: üöö Getting the code...
        uses: actions/checkout@v4

      - name: üêç Setting up Python...
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ‚ö° Caching dependencies for speed...
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
             ${{ runner.os }}-pip-

      - name: üõ†Ô∏è Installing tools and linters...
        run: python -m pip install --upgrade pip && pip install -r requirements.txt && pip install mypy flake8 black isort

      - name: üê∂ Summoning the reviewdog...
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest
          
      - name: üé® Performing Hybrid Linting Review...
        id: linting
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.APPROVER_TOKEN }}
        run: |
          # Default all statuses to PASSED
          echo "flake8_status=PASSED" >> $GITHUB_OUTPUT
          echo "black_status=PASSED" >> $GITHUB_OUTPUT
          echo "isort_status=PASSED" >> $GITHUB_OUTPUT
          echo "mypy_status=PASSED" >> $GITHUB_OUTPUT
          LINTER_FAILED_ANY=false
          
          # --- Running flake8 and black for inline comments ---
          # Always capture output to file, then check file content for failure
          echo "--- Running flake8 for inline comments ---"
          # Run flake8 and capture its output to flake8_report.txt
          # Using `|| true` to prevent script from exiting if flake8 fails,
          # allowing us to check the file content.
          flake8 src 2>&1 | tee flake8_raw_output.txt
          if [ -s flake8_raw_output.txt ]; then # Check if file exists and is not empty
            LINTER_FAILED_ANY=true
            echo "flake8_status=FAILED" >> $GITHUB_OUTPUT
            # Send the output to reviewdog for inline comments
            cat flake8_raw_output.txt | reviewdog -efm="%f:%l:%c: %m" -name="flake8" -reporter=github-pr-review
          fi

          echo "--- Running black for inline comments ---"
          # Run black and capture its output to black_report.txt
          black --check --diff src 2>&1 | tee black_raw_output.txt
          if [ -s black_raw_output.txt ]; then # Check if file exists and is not empty
            LINTER_FAILED_ANY=true
            echo "black_status=FAILED" >> $GITHUB_OUTPUT
            # Send the output to reviewdog for inline comments
            cat black_raw_output.txt | reviewdog -f=diff -f.diff.strip=1 -name="black" -reporter=github-pr-review
          fi

          echo "--- Running isort and mypy for summary reports ---"
          # isort output for summary report
          if ! isort_output=$(isort --check src 2>&1); then
                LINTER_FAILED_ANY=true
                echo "isort_status=FAILED" >> $GITHUB_OUTPUT
                echo "$isort_output" > isort_report.txt
          fi
          # mypy output for summary report
          if ! mypy_output=$(mypy src 2>&1); then
                LINTER_FAILED_ANY=true
                echo "mypy_status=FAILED" >> $GITHUB_OUTPUT
                echo "$mypy_output" > mypy_report.txt
          fi
          
          if [ "$LINTER_FAILED_ANY" = true ]; then
            echo "overall_status=FAILED" >> "$GITHUB_OUTPUT"
          else
            echo "overall_status=PASSED" >> "$GITHUB_OUTPUT"
          fi

      - name: üñ•Ô∏è Preparing the testing environment...
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: üß™ Running the critical App Test...
        id: app_test
        run: |
          if xvfb-run timeout 10s python src/main.py; then
            echo "status=PASSED" >> "$GITHUB_OUTPUT";
          else
            exit_code=$?;
            if [ $exit_code -eq 124 ]; then
              echo "status=PASSED" >> "$GITHUB_OUTPUT";
            else
              echo "status=FAILED" >> "$GITHUB_OUTPUT";
            fi
          fi

      - name: üìù Final, Intelligent Review and Team Huddle!
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.APPROVER_TOKEN }}
          script: |
            const fs = require('fs');
            const pr_author = context.payload.pull_request.user.login;
            const app_status = "${{ steps.app_test.outputs.status || 'FAILED' }}";
            const linter_status = "${{ steps.linting.outputs.overall_status || 'FAILED' }}";
            const flake8_status = "${{ steps.linting.outputs.flake8_status }}";
            const black_status = "${{ steps.linting.outputs.black_status }}";
            const isort_status = "${{ steps.linting.outputs.isort_status }}";
            const mypy_status = "${{ steps.linting.outputs.mypy_status }}";
            
            const app_check = app_status === 'PASSED' ? 'Passed ‚úÖ' : 'Failed ‚ùå';
            const linter_check = linter_status === 'PASSED' ? 'Looks good! ‚ú®' : 'Found some areas for improvement üî¨';

            let review_event = 'REQUEST_CHANGES';
            let body = `### PriestyBot Review Summary\n\nHello @${pr_author}! I've just finished reviewing your Python code. Here's a quick rundown of what I found:\n\n- **Application Test:** ${app_check}\n- **Linters:** ${linter_check}\n\n`;

            function getReport(name) {
              // Ensure we check for the existence before reading
              if (fs.existsSync(`${name}_report.txt`)) {
                  const content = fs.readFileSync(`${name}_report.txt`, 'utf8').trim();
                  return content !== '' ? content : 'No output captured or no issues found.';
              }
              return 'Report file not generated (no issues found by this linter).';
            }

            if (app_status === 'FAILED') {
              review_event = 'REQUEST_CHANGES';
              body += "The application test failed, which is the most critical issue. Please address that first!\n\n";
            } else if (app_status === 'PASSED' && linter_status === 'FAILED') {
              review_event = 'REQUEST_CHANGES';
              
              // NEW LOGIC FOR INLINE COMMENTS MESSAGE
              // We check the actual status outputs from the linting step,
              // and the presence/content of the raw output files for clarity.
              const flake8_has_issues = flake8_status === 'FAILED';
              const black_has_issues = black_status === 'FAILED';
              const summary_failed = (isort_status === 'FAILED' || mypy_status === 'FAILED');

              if (flake8_has_issues || black_has_issues) { 
                body += "I've left some inline comments for issues I found with `flake8` and/or `black`. Please check the 'Files Changed' tab for details.\n\n";
              }
              
              if (summary_failed) {
                body += "For our codebase-wide checks, I've found some issues and included the full reports below:\n\n";
                if (isort_status === 'FAILED') { body += `<details><summary><strong>isort (Import Sorter) found issues:</strong></summary>\n\n\`\`\`\n${getReport('isort')}\n\`\`\`\n\n</details>\n` }
                if (mypy_status === 'FAILED') { body += `<details><summary><strong>mypy (Type Checker) found issues:</strong></summary>\n\n\`\`\`\n${getReport('mypy')}\n\`\`\`\n\n</details>\n` }
              }
              body += `\nüí° **Tip:** For quick fixes on formatting and import sorting, you can comment \`/format\` on this PR.\n\nThese linter suggestions are advisory. If you believe they are incorrect or wish to proceed anyway, you can use the \`/approve\` command.`
            } else {
              review_event = 'APPROVE';
              body += "Everything looks fantastic! Great job. I'm approving this PR. Let's get this merged! üéâ";
            }
            
            await github.rest.pulls.createReview({ owner: context.repo.owner, repo: context.repo.repo, pull_number: context.issue.number, body: body, event: review_event });