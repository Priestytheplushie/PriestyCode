name: PriestyBot PR Review

on:
  pull_request:
    types: [ review_requested ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  code-review:
    if: github.event.action == 'review_requested' && github.event.requested_reviewer.login == 'PriestyBot'
    runs-on: ubuntu-latest
    steps:
      - name: ü§ñ PriestyBot, Reporting for Duty!
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.APPROVER_TOKEN }}
          script: |
            github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body: "PriestyBot, reporting for duty! ü´° I'll start my review now and post a final summary once I'm done. Wish me luck! üöÄ" });

      - name: üöö Getting the code...
        uses: actions/checkout@v4

      - name: üêç Setting up Python...
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ‚ö° Caching dependencies for speed...
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: üõ†Ô∏è Installing tools and linters...
        run: python -m pip install --upgrade pip && pip install -r requirements.txt && pip install mypy flake8 black isort

      - name: üê∂ Summoning the reviewdog...
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest
          
      - name: üé® Performing Intelligent Linting Review...
        id: linting
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.APPROVER_TOKEN }}
        run: |
          # Default all statuses to PASSED
          PR_SPECIFIC_ISSUES=false
          CODEBASE_WIDE_ISSUES=false
          
          # This robust logic now distinguishes between PR-specific and codebase-wide failures.
          echo "--- [1/4] Running flake8 ---"
          flake8_output=$(flake8 src 2>&1)
          if [ $? -ne 0 ]; then
            # We check if reviewdog would post any comments on the diff.
            if ! echo "$flake8_output" | reviewdog -efm="%f:%l:%c: %m" -name="flake8" -reporter=github-pr-review -level=error -fail-on-error=true; then
              PR_SPECIFIC_ISSUES=true
            fi
            # Always save the full report for the summary.
            echo "$flake8_output" > flake8_report.txt
            CODEBASE_WIDE_ISSUES=true
          fi
          
          echo "--- [2/4] Running black ---"
          black_output=$(black --check --diff src 2>&1)
          if [ $? -ne 0 ]; then
            if ! echo "$black_output" | reviewdog -f=diff -f.diff.strip=1 -name="black" -reporter=github-pr-review -level=error -fail-on-error=true; then
              PR_SPECIFIC_ISSUES=true
            fi
            echo "$black_output" > black_report.txt
            CODEBASE_WIDE_ISSUES=true
          fi

          echo "--- [3/4] Running isort ---"
          if ! isort_output=$(isort --check src 2>&1); then
            CODEBASE_WIDE_ISSUES=true
            echo "$isort_output" > isort_report.txt
          fi

          echo "--- [4/4] Running mypy ---"
          if ! mypy_output=$(mypy src 2>&1); then
            CODEBASE_WIDE_ISSUES=true
            echo "$mypy_output" > mypy_report.txt
          fi
          
          echo "pr_issues_found=$PR_SPECIFIC_ISSUES" >> "$GITHUB_OUTPUT"
          echo "codebase_issues_found=$CODEBASE_WIDE_ISSUES" >> "$GITHUB_OUTPUT"
          echo "Linting complete. Statuses: PR Issues - $PR_SPECIFIC_ISSUES, Codebase Issues - $CODEBASE_WIDE_ISSUES"
          
      - name: üñ•Ô∏è Preparing the testing environment...
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: üß™ Running the critical App Test...
        id: app_test
        run: |
          if xvfb-run timeout 10s python src/main.py; then echo "status=PASSED" >> "$GITHUB_OUTPUT";
          else
            exit_code=$?; if [ $exit_code -eq 124 ]; then echo "status=PASSED" >> "$GITHUB_OUTPUT";
            else echo "status=FAILED" >> "$GITHUB_OUTPUT"; fi
          fi

      - name: üìù Final, Intelligent Review and Team Huddle!
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.APPROVER_TOKEN }}
          script: |
            const fs = require('fs');
            const pr_author = context.payload.pull_request.user.login;
            const app_status = "${{ steps.app_test.outputs.status || 'FAILED' }}";
            const pr_issues = "${{ steps.linting.outputs.pr_issues_found }}" === "true";
            const codebase_issues = "${{ steps.linting.outputs.codebase_issues_found }}" === "true";

            let review_event = 'APPROVE'; // Default to Approve
            let body = `### PriestyBot Review Summary\n\nHello @${pr_author}! I've finished my review. Here's what I found:\n\n- **Application Test:** ${app_status === 'PASSED' ? 'Passed ‚úÖ' : 'Failed ‚ùå'}\n- **Linters:** ${!codebase_issues ? 'Looks good! ‚ú®' : 'Found some areas for improvement üî¨'}\n\n`;

            function getReport(name) {
              if (fs.existsSync(`${name}_report.txt`)) { return fs.readFileSync(`${name}_report.txt`, 'utf8'); }
              return '';
            }
            
            if (app_status === 'FAILED') {
              review_event = 'REQUEST_CHANGES';
              body += "The application test failed, which is the most critical issue. Please address that first!\n\n";
            } else if (pr_issues) {
              // Rule A: Issues found on the PR's changed lines. This is a mandatory change request.
              review_event = 'REQUEST_CHANGES';
              body += "I found some issues on the lines you changed in this PR and left inline comments for you. Please address these to get the PR approved.\n\n"
            } else if (codebase_issues) {
              // Rule B: No issues on the PR lines, but issues exist elsewhere. This is informational.
              review_event = 'COMMENT'; // Post a neutral comment, not a request/approval.
              body += "Your changes look good! üëç However, I did find some pre-existing issues in other parts of the codebase. You are not required to fix these, but I wanted to make you aware of them:\n\n"
              const black_report = getReport('black');
              const flake8_report = getReport('flake8');
              const isort_report = getReport('isort');
              const mypy_report = getReport('mypy');
              if (flake8_report) { body += `<details><summary><strong>flake8 Report</strong></summary>\n\n\`\`\`\n${flake8_report}\n\`\`\`\n\n</details>\n`; }
              if (black_report) { body += `<details><summary><strong>Black Report</strong></summary>\n\n\`\`\`diff\n${black_report}\n\`\`\`\n\n</details>\n`; }
              if (isort_report) { body += `<details><summary><strong>isort Report</strong></summary>\n\n\`\`\`\n${isort_report}\n\`\`\`\n\n</details>\n`; }
              if (mypy_report) { body += `<details><summary><strong>mypy Report</strong></summary>\n\n\`\`\`\n${mypy_report}\n\`\`\`\n\n</details>\n`; }
            } else {
              // Rule C: App passed and no linter issues were found anywhere.
              review_event = 'APPROVE';
              body += "Everything looks fantastic! Great job. I'm approving this PR. Let's get it merged! üéâ";
            }
            
            await github.rest.pulls.createReview({ owner: context.repo.owner, repo: context.repo.repo, pull_number: context.issue.number, body: body, event: review_event });