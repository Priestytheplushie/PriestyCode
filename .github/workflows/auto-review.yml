name: PriestyBot PR Review

on:
  pull_request:
    types: [review_requested]

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

jobs:
  security-scan:
    if: github.event.requested_reviewer.login == 'PriestyBot'
    runs-on: ubuntu-latest
    steps:
      - name: üïµÔ∏è‚Äç‚ôÄÔ∏è Acknowledging Security Scan Start
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.APPROVER_TOKEN }}
          script: |
            github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body: "I've also started the deep security scan with CodeQL! üïµÔ∏è‚Äç‚ôÄÔ∏è This will run in the background. I'll post another update here as soon as it's done!" });

      - name: ‚¨áÔ∏è Checking out the code
        uses: actions/checkout@v4

      - name: üõ°Ô∏è Initializing CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'python'

      - name: üî¨ Performing CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: ‚úÖ Announce Security Scan Completion
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.APPROVER_TOKEN }}
          script: |
            const conclusion = "${{ job.status }}";
            const body = (conclusion === 'success')
              ? "Security scan complete! ‚úÖ I didn't find any new vulnerabilities. Great job keeping our code safe!"
              : "Security scan complete! ‚ö†Ô∏è I found some potential issues. Please check the 'Security' tab on the PR for the full details.";
            github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body: body });

  code-review:
    if: github.event.requested_reviewer.login == 'PriestyBot'
    runs-on: ubuntu-latest
    steps:
      - name: ü§ñ PriestyBot, Reporting for Duty!
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.APPROVER_TOKEN }}
          script: |
            github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body: "PriestyBot, reporting for duty! ü´° Thanks for having me. I'm starting the review process right now and will be back with updates soon! üöÄ" });

      - name: ‚¨áÔ∏è Checking out the code...
        uses: actions/checkout@v4

      - name: üêç Setting up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: üì¶ Caching and Installing Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: üíª Installing Python Linters
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install mypy flake8 black isort

      - name: üê∂ Setting up reviewdog
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest
          
      - name: üé® Reviewing Code Style (Linters)
        id: linting
        continue-on-error: true # Keep workflow running
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -o pipefail
          LINTING_FAILED=false
          
          echo "--- Running Linters ---"
          if ! flake8 src | reviewdog -efm="%f:%l:%c: %m" -name="flake8" -reporter=github-pr-review -filter-mode=nofilter -fail-on-error=true; then LINTING_FAILED=true; fi
          if ! mypy src | reviewdog -f=mypy -name="mypy" -reporter=github-pr-review -filter-mode=nofilter -fail-on-error=true; then LINTING_FAILED=true; fi
          if ! black --check --diff src | reviewdog -f=diff -f.diff.strip=1 -name="black" -reporter=github-pr-review -filter-mode=nofilter -fail-on-error=true; then LINTING_FAILED=true; fi
          if ! isort --check --diff src | reviewdog -f=diff -f.diff.strip=1 -name="isort" -reporter=github-pr-review -filter-mode=nofilter -fail-on-error=true; then LINTING_FAILED=true; fi
          
          if [ "$LINTING_FAILED" = true ]; then
            echo "LINTER_OVERALL_STATUS=FAILED" >> "$GITHUB_ENV"
          else
            echo "LINTER_OVERALL_STATUS=PASSED" >> "$GITHUB_ENV"
          fi

      - name: üñ•Ô∏è Installing Display Server for App Test
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: üß™ Time for the App Test!
        id: app_test
        continue-on-error: true
        run: |
          echo "Running the Tkinter App Test now! Fingers crossed! ü§û"
          # App Test script remains the same...
          if xvfb-run timeout 10s python src/main.py; then
            echo "App test PASSED: Exited cleanly before timeout."; echo "APP_TEST_STATUS=PASSED" >> "$GITHUB_ENV"; echo "APP_TEST_REASON=Exited cleanly before timeout." >> "$GITHUB_ENV";
          else
            exit_code=$?; if [ $exit_code -eq 124 ]; then
              echo "App test PASSED: Ran for 10s and was terminated as expected."; echo "APP_TEST_STATUS=PASSED" >> "$GITHUB_ENV"; echo "APP_TEST_REASON=Ran for 10s and was terminated as expected." >> "$GITHUB_ENV";
            else
              echo "App test FAILED: App crashed with exit code $exit_code."; echo "APP_TEST_STATUS=FAILED" >> "$GITHUB_ENV"; echo "APP_TEST_REASON=App crashed with exit code $exit_code." >> "$GITHUB_ENV";
            fi
          fi

      - name: üìù Final Review and Team Huddle!
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.APPROVER_TOKEN }}
          script: |
            // This script remains the same, but will now receive the CORRECT LINTER_OVERALL_STATUS
            const app_status = "${{ env.APP_TEST_STATUS }}";
            const app_reason = "${{ env.APP_TEST_REASON }}";
            const linter_status = "${{ env.LINTER_OVERALL_STATUS }}";
            const black_status = "${{ env.BLACK_STATUS }}"; // This is less relevant now, but harmless
            const isort_status = "${{ env.ISORT_STATUS }}"; // This is less relevant now, but harmless
            
            const app_emoji = app_status === 'PASSED' ? 'üëç' : 'üëé';
            const linter_emoji = linter_status === 'PASSED' ? 'üëç' : 'üëé';

            let review_event = 'REQUEST_CHANGES';
            let body = `### PriestyBot's Review Summary\n\nHi team! I've finished my complete review. Here's the rundown:\n\n- **App Test:** ${app_emoji}\n  - _Reason: ${app_reason}_\n- **Linter Health:** ${linter_emoji}\n- **CodeQL Security Scan:** üïµÔ∏è‚Äç‚ôÄÔ∏è Running in parallel. I'll post a separate comment when it's done.\n\n---\n\n`;

            if (app_status === 'FAILED') {
              review_event = 'REQUEST_CHANGES';
              body += "üö® **Okay team, let's huddle up!** üö®\n\nThe most critical check, the **app test, has failed**. This is our top priority! Let's focus our amazing brainpower on fixing this. I have full faith we can solve it.\n\nI also left some notes on code style, but we can totally ignore those until the app test is green. ‚úÖ";
            } else if (app_status === 'PASSED' && linter_status === 'FAILED') {
              review_event = 'REQUEST_CHANGES';
              body += "‚≠ê **Fantastic news! The app test passed beautifully!** The application is solid! ‚≠ê\n\nOn the code style front, I did find a few areas for improvement and left some advisory comments. Since these are just suggestions, this PR is very close!\n\nHere are your options:\n- **To automatically fix formatting**, just comment `/format` on this PR.\n- **To bypass my suggestions and approve**, just comment `/approve`.\n\nLet me know how you'd like to proceed! I'm requesting changes for now, but you have the power to override me."
            } else { // Everything passed
              review_event = 'APPROVE';
              body += "üéâ **WE DID IT! EVERYTHING IS PERFECT!** üéâ\n\nThis is amazing! The code is clean, the app test passed with flying colors... this is a thing of beauty. I'm so proud of this work! I'm smashing that **Approve** button. Let's get this merged! ü•≥";
            }
            
            github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: body,
              event: review_event,
            });