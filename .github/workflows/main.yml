name: PriestyBot PR Manager

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [review_requested]

permissions:
  pull-requests: write
  contents: read
  checks: write

jobs:
  # JOB 1: Handles simple, lightweight commands that don't need a full review.
  command-handler:
    name: Handle Comment Commands
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && github.event.sender.type != 'Bot'
    runs-on: ubuntu-latest
    steps:
      - name: Get Comment Body
        run: echo "COMMENT_BODY=${{ github.event.comment.body }}" >> $GITHUB_ENV

      - name: Handle /approve
        if: startsWith(env.COMMENT_BODY, '/approve') || contains(env.COMMENT_BODY, '@PriestyBot approve')
        run: |
          RAW_COMMENT="${{ env.COMMENT_BODY }}"
          if [[ "$RAW_COMMENT" == /approve* ]]; then
            BODY="${RAW_COMMENT#*/approve}"; BODY=$(echo "$BODY" | xargs)
            if [ -z "$BODY" ]; then BODY="Alright, approved as you asked!"; fi
          else
            BODY="You got it! I've approved this pull request. ðŸ‘"
          fi
          gh pr review ${{ github.event.issue.number }} --approve --body "$BODY"
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }

      - name: Handle /review and /dismiss commands
        if: |
          startsWith(env.COMMENT_BODY, '/review') ||
          startsWith(env.COMMENT_BODY, '/dismiss') ||
          contains(env.COMMENT_BODY, '@PriestyBot review')
        run: |
          gh pr comment ${{ github.event.issue.number }} --body "To kick off a full automated review, please head over to the **Reviewers** panel on the right side of this page and formally request a review from me, **PriestyBot**. That gives me the green light to run all the checks!"
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }

  # JOB 2: The full review job. It ONLY runs when a review is formally requested.
  full-review:
    name: Run Full Automated Review
    if: github.event_name == 'pull_request' && github.event.action == 'review_requested' && github.event.requested_reviewer.login == 'PriestyBot'
    runs-on: ubuntu-latest
    steps:
      - name: "Acknowledge Request: Let's see what we've got..."
        run: >
          gh pr comment ${{ github.event.pull_request.number }} --body "Thanks for the ping! I'm pulling down the code now and getting the test environment ready. I'll report back with what I find. ðŸ§"
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }

      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Environment and Dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y python3-tk xvfb
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install flake8

      - name: Setup Reviewdog
        uses: reviewdog/action-setup@v1

      - name: "Run Advisory Linters (will not block)"
        id: linting
        continue-on-error: true
        run: |
          set +o pipefail
          flake8 . | reviewdog -f=flake8 -name="Advisory Linter (flake8)" -reporter=github-pr-check -level=warning
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          set -o pipefail
          if [ ${LINT_EXIT_CODE} -ne 0 ]; then echo "linter_issues_found=true" >> $GITHUB_OUTPUT; else echo "linter_issues_found=false" >> $GITHUB_OUTPUT; fi
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.APPROVER_TOKEN }}
          
      - name: "Run App Test: The Moment of Truth"
        id: app_test
        run: |
          echo "Alright, moment of truth. Attempting to launch the app..."
          set +e
          timeout 30s xvfb-run python .github/scripts/run_test.py > app_output.txt 2>&1
          APP_EXIT_CODE=$?
          set -e
          echo "app_exit_code=${APP_EXIT_CODE}" >> $GITHUB_OUTPUT
          if [ ${APP_EXIT_CODE} -ne 0 ]; then
            {
              echo "Whoops! The app test failed. It looks like the program crashed on startup. This is usually due to a bug or an import error in the code."
              echo ""
              echo "Here's the technical log I captured:"
              echo '```'
              cat app_output.txt
              echo '```'
            } > failure_comment.txt
            echo "failure_comment_file=failure_comment.txt" >> $GITHUB_OUTPUT
          fi

      - name: Post Final Verdict
        id: final_verdict
        if: steps.app_test.conclusion == 'success'
        run: |
          if [ "${{ steps.app_test.outputs.app_exit_code }}" == "0" ]; then
            LINT_MESSAGE="By the way, I also ran the linter and it passed with flying colors. "
            if [ "${{ steps.linting.outputs.linter_issues_found }}" == "true" ]; then
              LINT_MESSAGE="By the way, I also ran the linter and left some suggestions as inline comments on the changed files. They're just advisory, but might be helpful! "
            fi
            MESSAGE="I've finished my review! ${LINT_MESSAGE}The most important thing is that the application test harness started up and shut down cleanly. Looking good! I'm approving this. âœ…"
            gh pr review ${{ github.event.pull_request.number }} --approve --body "$MESSAGE"
          else
            gh pr review ${{ github.event.pull_request.number }} --request-changes --body-file ${{ steps.app_test.outputs.failure_comment_file }}
          fi
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }
-
      - name: Report Bot Failure
        if: failure() && steps.final_verdict.conclusion != 'success'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "ðŸ’¥ **Bot Error!** ðŸ’¥

          Yikes! I encountered an unexpected internal error and couldn't finish my review. This is a problem with my own machinery, not your code. 

          A human should check the [Action logs for this run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) to see the full technical details."
        env:
          GH_TOKEN: ${{ secrets.APPROVER_TOKEN }}
          GH_REPO: ${{ github.repository }}