name: PriestyBot PR Manager

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [review_requested]

permissions:
  pull-requests: write
  contents: read
  checks: write

jobs:
  # JOB 1: Handles simple, lightweight commands that don't need a full review.
  command-handler:
    name: Handle Comment Commands
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && github.event.sender.type != 'Bot'
    runs-on: ubuntu-latest
    steps:
      - name: Get Comment Body
        run: echo "COMMENT_BODY=${{ github.event.comment.body }}" >> $GITHUB_ENV

      # --- THE CORRECTED /help COMMAND ---
      - name: Handle /help
        if: |
          startsWith(env.COMMENT_BODY, '/help') ||
          (contains(env.COMMENT_BODY, '@PriestyBot') && contains(env.COMMENT_BODY, 'help'))
        run: |
          gh pr comment ${{ github.event.issue.number }} --body "
          ### Hello! I'm PriestyBot. 👋
          
          Here are the commands you can use by writing a new comment:

          *   **`/approve [message]`**
              > Approves the pull request with an optional message. You can also say things like \`@PriestyBot approve this\`.

          *   **`/request-changes <message>`**
              > Submits a review requesting changes, using your message as the reason. *This is a required field.*

          *   **`/comment <message>`**
              > Leaves a regular comment on the pull request without changing the review status. *This is a required field.*
          
          *   **Requesting a Review**
              > To run the full suite of checks (linters + app launch test), please use the formal **'Request a review'** feature in the GitHub sidebar and select me. Commenting \`/review\` or \`/dismiss\` will also remind you how to do this.

          *   **`/help`**
              > Shows this help message. You can also just mention me and ask for help!
          "
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }

      - name: Handle /approve
        # This `if` condition needs to be more specific to avoid firing on a help request.
        if: (startsWith(env.COMMENT_BODY, '/approve') || contains(env.COMMENT_BODY, '@PriestyBot approve')) && !contains(env.COMMENT_BODY, 'help')
        run: |
          RAW_COMMENT="${{ env.COMMENT_BODY }}"
          if [[ "$RAW_COMMENT" == /approve* ]]; then
            BODY="${RAW_COMMENT#*/approve}"; BODY=$(echo "$BODY" | xargs)
            if [ -z "$BODY" ]; then BODY="Alright, approved as you asked!"; fi
          else
            BODY="You got it! I've approved this pull request. 👍"
          fi
          gh pr review ${{ github.event.issue.number }} --approve --body "$BODY"
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }

      # --- These commands were missing from the help message, but their logic is here ---
      - name: Handle /request-changes
        if: startsWith(env.COMMENT_BODY, '/request-changes')
        run: |
          RAW_COMMENT="${{ env.COMMENT_BODY }}"; CHANGES="${RAW_COMMENT#*/request-changes}"; CHANGES=$(echo "$CHANGES" | xargs)
          if [ -z "$CHANGES" ]; then echo "Error: The /request-changes command requires a reason."; exit 1; fi
          gh pr review ${{ github.event.issue.number }} --request-changes --body "$CHANGES"
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }

      - name: Handle /comment
        if: startsWith(env.COMMENT_BODY, '/comment')
        run: |
          RAW_COMMENT="${{ env.COMMENT_BODY }}"; COMMENT_TEXT="${RAW_COMMENT#*/comment}"; COMMENT_TEXT=$(echo "$COMMENT_TEXT" | xargs)
          if [ -z "$COMMENT_TEXT" ]; then echo "Error: The /comment command requires text."; exit 1; fi
          gh pr comment ${{ github.event.issue.number }} --body "$COMMENT_TEXT"
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }

      - name: Handle /review and /dismiss guidance
        # This `if` condition needs to be more specific to avoid firing on a help request.
        if: (startsWith(env.COMMENT_BODY, '/review') || startsWith(env.COMMENT_BODY, '/dismiss') || contains(env.COMMENT_BODY, '@PriestyBot review')) && !contains(env.COMMENT_BODY, 'help')
        run: |
          gh pr comment ${{ github.event.issue.number }} --body "To kick off a full automated review, please head over to the **Reviewers** panel on the right side of this page and formally request a review from me, **PriestyBot**. That gives me the green light to run all the checks! (You can also type \`/help\` for more info)."
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }

  # JOB 2: The full review job. It ONLY runs when a review is formally requested.
  full-review:
    name: Run Full Automated Review
    if: github.event_name == 'pull_request' && github.event.action == 'review_requested' && github.event.requested_reviewer.login == 'PriestyBot'
    runs-on: ubuntu-latest
    steps:
      - name: "Acknowledge Request: Let's see what we've got..."
        run: >
          gh pr comment ${{ github.event.pull_request.number }} --body "Thanks for the ping! I'm running the checks now. I'll check for code quality with a linter and run a test to ensure the app can launch. I'll be back shortly! 🧐"
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }

      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Environment and Dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y python3-tk xvfb
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install flake8

      - name: Setup Reviewdog
        uses: reviewdog/action-setup@v1

      - name: "Run Advisory Linters (will not block)"
        id: linting
        continue-on-error: true
        run: |
          set +o pipefail
          flake8 . | reviewdog -f=flake8 -name="Advisory Linter (flake8)" -reporter=github-pr-check -level=warning
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          set -o pipefail
          if [ ${LINT_EXIT_CODE} -ne 0 ]; then echo "linter_issues_found=true" >> $GITHUB_OUTPUT; else echo "linter_issues_found=false" >> $GITHUB_OUTPUT; fi
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.APPROVER_TOKEN }}
          
      - name: "Run App Launch Test"
        id: app_test
        run: |
          echo "Running app launch test for 10 seconds..."
          set +e
          timeout 10s xvfb-run python -m src.main > app_output.txt 2>&1
          APP_EXIT_CODE=$?
          set -e
          
          if [ ${APP_EXIT_CODE} -eq 124 ]; then
            echo "App ran for 10 seconds without crashing. Test PASSED."
            echo "app_exit_code=0" >> $GITHUB_OUTPUT
          else
            echo "App crashed before timeout. Test FAILED with exit code ${APP_EXIT_CODE}."
            echo "app_exit_code=${APP_EXIT_CODE}" >> $GITHUB_OUTPUT
            {
              echo "Whoops! The app launch test failed. The program crashed on startup."
              echo ""
              echo "Here's the technical log I captured:"
              echo '```'
              cat app_output.txt
              echo '```'
            } > failure_comment.txt
            echo "failure_comment_file=failure_comment.txt" >> $GITHUB_OUTPUT
          fi

      - name: Post Final Verdict
        if: steps.app_test.conclusion == 'success'
        run: |
          if [ "${{ steps.app_test.outputs.app_exit_code }}" == "0" ]; then
            LINT_MESSAGE="The linter also passed with flying colors. "
            if [ "${{ steps.linting.outputs.linter_issues_found }}" == "true" ]; then
              LINT_MESSAGE="I also ran the linter and left some suggestions as inline comments for you to consider. "
            fi
            MESSAGE="I've finished my review! ${LINT_MESSAGE}The main thing is that the application passed the launch test, meaning it started up without crashing. Looking good! I'm approving this. ✅"
            gh pr review ${{ github.event.pull_request.number }} --approve --body "$MESSAGE"
          else
            gh pr review ${{ github.event.pull_request.number }} --request-changes --body-file ${{ steps.app_test.outputs.failure_comment_file }}
          fi
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }