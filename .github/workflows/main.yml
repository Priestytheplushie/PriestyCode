name: PriestyBot PR Manager

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [review_requested]

permissions:
  pull-requests: write
  contents: read
  checks: write

jobs:
  # JOB 1: Handles simple commands.
  command-handler:
    name: Handle Comment Commands
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && github.event.sender.type != 'Bot'
    runs-on: ubuntu-latest
    steps:
      - name: Get Comment Body
        run: echo "COMMENT_BODY=${{ github.event.comment.body }}" >> $GITHUB_ENV

      - name: Handle /approve
        if: startsWith(env.COMMENT_BODY, '/approve') || contains(env.COMMENT_BODY, '@PriestyBot approve')
        run: |
          RAW_COMMENT="${{ env.COMMENT_BODY }}"
          if [[ "$RAW_COMMENT" == /approve* ]]; then
            BODY="${RAW_COMMENT#*/approve}"; BODY=$(echo "$BODY" | xargs)
            if [ -z "$BODY" ]; then BODY="Alright, approved as you asked!"; fi
          else
            BODY="You got it! I've approved this pull request. 👍"
          fi
          gh pr review ${{ github.event.issue.number }} --approve --body "$BODY"
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }

      - name: Handle /review and /dismiss commands
        if: |
          startsWith(env.COMMENT_BODY, '/review') ||
          startsWith(env.COMMENT_BODY, '/dismiss') ||
          contains(env.COMMENT_BODY, '@PriestyBot review')
        run: |
          gh pr comment ${{ github.event.issue.number }} --body "To kick off a full automated review, please head over to the **Reviewers** panel on the right side of this page and formally request a review from me, **PriestyBot**. That gives me the green light to run all the checks!"
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }

  # JOB 2: The full review job.
  full-review:
    name: Run Full Automated Review
    if: github.event_name == 'pull_request' && github.event.action == 'review_requested' && github.event.requested_reviewer.login == 'PriestyBot'
    runs-on: ubuntu-latest
    steps:
      - name: "Acknowledge Request: Let's see what we've got..."
        run: >
          gh pr comment ${{ github.event.pull_request.number }} --body "Thanks for the ping! I'm running the checks now. I'll check for code quality with a linter and run a smoke test to ensure the code is structurally sound. I'll be back shortly! 🧐"
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }

      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Environment and Dependencies
        run: |
          # We no longer need GUI libraries for the new smoke test.
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install flake8

      - name: Setup Reviewdog
        uses: reviewdog/action-setup@v1

      - name: "Run Advisory Linters (will not block)"
        id: linting
        continue-on-error: true
        run: |
          set +o pipefail
          flake8 . | reviewdog -f=flake8 -name="Advisory Linter (flake8)" -reporter=github-pr-check -level=warning
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          set -o pipefail
          if [ ${LINT_EXIT_CODE} -ne 0 ]; then echo "linter_issues_found=true" >> $GITHUB_OUTPUT; else echo "linter_issues_found=false" >> $GITHUB_OUTPUT; fi
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.APPROVER_TOKEN }}
          
      - name: "Run Code Integrity Smoke Test"
        id: smoke_test
        run: |
          echo "Running smoke test to check for syntax and import errors..."
          set +e
          # We just run the new, simpler script. No xvfb or timeout needed.
          python .github/scripts/run_test.py > app_output.txt 2>&1
          APP_EXIT_CODE=$?
          set -e
          echo "app_exit_code=${APP_EXIT_CODE}" >> $GITHUB_OUTPUT
          if [ ${APP_EXIT_CODE} -ne 0 ]; then
            {
              echo "Whoops! The code integrity smoke test failed. This means there's a fatal `SyntaxError` or `ImportError` that needs to be fixed."
              echo ""
              echo "Here's the technical log I captured:"
              echo '```'
              cat app_output.txt
              echo '```'
            } > failure_comment.txt
            echo "failure_comment_file=failure_comment.txt" >> $GITHUB_OUTPUT
          fi

      - name: Post Final Verdict
        if: steps.smoke_test.conclusion == 'success'
        run: |
          if [ "${{ steps.smoke_test.outputs.app_exit_code }}" == "0" ]; then
            LINT_MESSAGE="The linter also passed with flying colors. "
            if [ "${{ steps.linting.outputs.linter_issues_found }}" == "true" ]; then
              LINT_MESSAGE="I also ran the linter and left some suggestions as inline comments for you to consider. "
            fi
            MESSAGE="I've finished my review! ${LINT_MESSAGE}The main thing is that the code passed the integrity smoke test, meaning all imports and syntax are correct. Looking good! I'm approving this. ✅"
            gh pr review ${{ github.event.pull_request.number }} --approve --body "$MESSAGE"
          else
            gh pr review ${{ github.event.pull_request.number }} --request-changes --body-file ${{ steps.smoke_test.outputs.failure_comment_file }}
          fi
        env: { GH_TOKEN: "${{ secrets.APPROVER_TOKEN }}", GH_REPO: "${{ github.repository }}" }